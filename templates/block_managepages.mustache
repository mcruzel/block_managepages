<div>
    <h2>{{#str}} select_pages, block_managepages {{/str}}</h2>
    <form method="post" action="{{{exporturl}}}" id="export-form">
        <input type="hidden" name="sesskey" value="{{sesskey}}" />
        <input type="hidden" id="block-managepages-courseid" value="{{courseid}}" />
        <div>
            <label>{{#str}} select_page_label, block_managepages {{/str}}</label>
            <div style="max-height:350px; overflow-y:auto; border:1px solid #ccc; padding:8px; width:100%;">
                {{#sections}}
                    <div style="margin-bottom:0;">
                        <strong>{{name}}</strong>
                        <ul style="margin:0; padding-left:20px;">
                        {{#pages}}
                            <li style="margin:0; padding:0; list-style:none; display:flex; align-items:center; gap:6px;">
                                <button type="button" class="edit-page-btn" data-pageid="{{id}}" title="{{#str}} edit, block_managepages {{/str}}" style="background:none;border:none;cursor:pointer;padding:0;display:flex;align-items:center;">
                                    <span style="font-size:1.1em;line-height:1;display:inline-block;width:18px;height:18px;vertical-align:middle;">
                                        <svg width="16" height="16" viewBox="0 0 16 16" style="display:block;" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12.146 2.146a.5.5 0 0 1 .708 0l1 1a.5.5 0 0 1 0 .708l-8.5 8.5a.5.5 0 0 1-.168.11l-3 1a.5.5 0 0 1-.637-.637l1-3a.5.5 0 0 1 .11-.168l8.5-8.5zm.708-.708A1.5 1.5 0 0 0 12.146.146l-8.5 8.5a1.5 1.5 0 0 0-.33.5l-1 3a1.5 1.5 0 0 0 1.91 1.91l3-1a1.5 1.5 0 0 0 .5-.33l8.5-8.5a1.5 1.5 0 0 0 0-2.12l-1-1z"/>
                                        </svg>
                                    </span>
                                </button>
                                <label style="display:block; margin:0; flex:1;">
                                    <input type="checkbox" name="page_ids[]" value="{{id}}"> {{name}}
                                </label>
                            </li>
                        {{/pages}}
                        </ul>
                    </div>
                {{/sections}}
            </div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center; margin-top:10px;">
            <button type="submit">{{#str}} export_markdown, block_managepages {{/str}}</button>
            <button type="button" id="copy-markdown-btn">üìã {{#str}} copy_to_clipboard, block_managepages {{/str}}</button>
        </div>
    </form>
    <textarea id="markdown-content" style="display:none;"></textarea>
    <script>
    function block_managepages_init() {
        var form = document.getElementById('export-form');
        var copyBtn = document.getElementById('copy-markdown-btn');
        var textarea = document.getElementById('markdown-content');
        if (!form || !copyBtn) return;
        copyBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            var checkboxes = document.querySelectorAll('input[name="page_ids[]"]:checked');
            var selected = Array.from(checkboxes).map(cb => cb.value);
            if (selected.length === 0) {
                alert('Veuillez s√©lectionner au moins une page.');
                return;
            }
            var courseid = new URLSearchParams(window.location.search).get('id');
            if (!courseid) {
                var courseInput = document.getElementById('block-managepages-courseid');
                if (courseInput) {
                    courseid = courseInput.value;
                }
            }
            var sesskey = document.querySelector('input[name="sesskey"]').value;
            var response = await fetch(M.cfg.wwwroot + '/blocks/managepages/export.php?ajax=1&sesskey=' + encodeURIComponent(sesskey) + '&courseid=' + courseid + '&page_ids[]=' + selected.join('&page_ids[]='));
            if (response.ok) {
                var data = await response.json();
                textarea.value = data.markdown;
                textarea.style.display = 'block';
                textarea.select();
                document.execCommand('copy');
                textarea.style.display = 'none';
                alert('Contenu copi√© dans le presse-papier !');
            } else {
                alert('Erreur lors de la r√©cup√©ration du contenu Markdown.');
            }
        });
        // Ajout de la gestion du bouton "Modifier"
        document.querySelectorAll('.edit-page-btn').forEach(function(btn) {
            btn.addEventListener('click', async function(e) {
                e.preventDefault();
                var pageid = btn.getAttribute('data-pageid');
                var courseid = new URLSearchParams(window.location.search).get('id');
                if (!courseid) {
                    var courseInput = document.getElementById('block-managepages-courseid');
                    if (courseInput) {
                        courseid = courseInput.value;
                    }
                }
                var sesskey = document.querySelector('input[name="sesskey"]').value;
                try {
                    var response = await fetch(M.cfg.wwwroot + '/blocks/managepages/export.php?ajax=2&sesskey=' + encodeURIComponent(sesskey) + '&courseid=' + courseid + '&pageid=' + pageid);
                    var data = await response.json();
                    if (response.ok && data && typeof data.content !== 'undefined') {
                        showEditModal(pageid, data.name, data.content, courseid, sesskey);
                    } else {
                        alert(data.error || 'Erreur lors de la r√©cup√©ration du contenu de la page.');
                    }
                } catch (err) {
                    alert('Erreur lors de la r√©cup√©ration du contenu de la page.');
                }
            });
        });

        function showEditModal(pageid, name, content, courseid, sesskey) {
            var modal = document.createElement('div');
            modal.id = 'edit-page-modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.4)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = 9999;
            modal.innerHTML = `
                <div style="background:#fff;padding:20px;border-radius:8px;min-width:350px;max-width:90vw;max-height:90vh;overflow:auto;">
                    <h3>Modifier : ${name}</h3>
                    <textarea id="edit-page-content" style="width:100%;height:200px;">${content}</textarea>
                    <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end;">
                        <button id="save-edit-page">Enregistrer</button>
                        <button id="cancel-edit-page">Annuler</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('cancel-edit-page').onclick = function() {
                document.body.removeChild(modal);
            };
            document.getElementById('save-edit-page').onclick = async function() {
                var newcontent = document.getElementById('edit-page-content').value;
                var response = await fetch(M.cfg.wwwroot + '/blocks/managepages/export.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: 'ajax=3&sesskey=' + encodeURIComponent(sesskey) + '&courseid=' + courseid + '&pageid=' + pageid + '&content=' + encodeURIComponent(newcontent)
                });
                if (response.ok) {
                    alert('Page enregistr√©e !');
                    document.body.removeChild(modal);
                    location.reload();
                } else {
                    alert('Erreur lors de l\'enregistrement.');
                }
            };
        }
    }
    window.addEventListener('load', block_managepages_init);
    </script>
    {{#message}}
        <div class="message">{{message}}</div>
    {{/message}}
</div>
